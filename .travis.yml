os: linux
dist: xenial
language: python
python: '3.7'
cache:
- directories:
  - "$HOME/.npm"
- pip
jobs:
  include:
  - stage: install
    install:
    - pip install -r requirements.txt
    - cd frontend
    - npm ci
    script: skip
  - stage: test
    script:
    - flake8 .
    - mypy invisible_flow
    - pytest --cov=invisible_flow tests --cov-fail-under 70
    - python run-api-tests.py
    - cd frontend
    - npm ci && npm run test
  - stage: Heroku_deploy
    if: branch = master
    before_deploy: cd frontend && npm ci && npm run build && cd ..
    deploy:
      provider: heroku
      api_key:
        secure: QbWwVT3L9osHvPlRF4alMEONziI0OPJAFSO8YpsB1moKQv19TBBLsZkwATOzaL4MNp/e6DybNmLIJX5NwmEljcdekATePiUzj1h8HmqNC4vcc7AUZtxBMdIA3jcKkfJIqvCPK5QYH6n7+9uhVXKUNvOZTTH9oGIUurUP+5aeOOJ5xcfKsQkkdGiPMgbLhIjRUApdHkSuFv+shrASSb/lN3SwcB598Dpg70btRQ/Xl8BaT6q/3kcP4eWJDufG8dQezattQBqUIHZD8heCuUzcangSOdoI/bHuOwM0qh+OgxirzXQ8Be32GnPnXRgG2t/8KQg3VyTvfJrHQbv7HeLMdV2R0L1UJGYKp+1ns/I5Kqw6UMQqdAgiy2Wwjc5u+X21gFuPD/Ve7bBXuBU7R5hMMbUVcJtb/v8QF+HlyCu+DEey4MBzJWjGFZh1a5ygNP4XlZbm5XYm+rjevA5ptEwc/LlrBKgkzwvO3+DA0qis8StZ2PPHJozKvpJRQobtzFzJoTBJLMtUzFlocr9toIbkK/lKvzW0ur2shXbj4hcxboi5bxo0UwJu+3YoR4tGP8s4PXo3j1KPcdtDXfqjOpGu2SJYYPS0/Z47deYlACsIIkrY7PDi0XtOMrwNQ3bH5YI9PFSy5YT/yEVxyg5ZysS9DB4E4RfpH+9d4p7eThaQCnk=
      app: invisiflow-testing
      on:
        repo: invinst/invisible-flow
      skip_cleanup: true
    script: skip
  - stage: GAE_deploy
    if: branch = master
    before_script:
    - openssl aes-256-cbc -k $SS_PW -in gae-keyfile-dev.json.enc -out gae-keyfile-dev.json -d
    before_deploy:
    - echo "${TRAVIS_COMMIT}" > invisible_flow/commit
    deploy:
      provider: gae
      keyfile: "$GAE_KEYFILE"
      project: "$GAE_PROJECT_ID"
      version: "$GAE_VERSION"
      file:
      - invisible_flow/commit
      on:
        repo: invinst/invisible-flow
      skip_cleanup: true
    env:
      - GIT_COMMIT_ID=`echo $TRAVIS_COMMIT`
    after_script:
      - cat invisible_flow/commit
  - stage: GCS_deploy
    if: branch = master
    before_install:
      - openssl aes-256-cbc -k $SS_PW -in gae-keyfile-dev.json.enc -out gae-keyfile-dev.json -d
      - cd frontend
    install:
      - npm ci
    before_deploy:
      - npm run build
    deploy:
      provider: gcs
      edge:
        branch: gcs-ng
      project_id: "$GAE_PROJECT_ID"
      credentials: "..gae-keyfile-dev.json"
      bucket: invisible-flow-dev
      local-dir: build
      on:
        repo: invinst/invisible-flow
      skip_cleanup: true
      acl: public-read
    env:
    - PUBLIC_URL=https://storage.cloud.google.com/invisible-flow-dev/
    script: skip
env:
  global:
    secure: QtSkwjcslKJ7LyjP0cLuiIBbL6P+aii0xN+2sk2YS3IK4jDVyagyPcDmXAGml7uqXZjgSj6TBoJP8t51S9OJSG4HZhfcG5cj62q/RiglONSQzqHKOCaBfEypd8Nrtkx31MMQLmpJuIHrZtQUhHN1vBYDzdo0Iti/5CukgSqb67RuxL1aGmXkUkAJwd8JTmgH85dfZ+E5sD4Ns3LU3F5IQqk7gJ/y9gLMmV8wiUWStBwTeQCV8Kp9qVMFUonHAB5OzEuYRaasYr05XlcyByxWOJPhcPHEkXs1KGobhjph07UxZ49ORzrvtj6Go0hDLkti5Nenpltc1w4nrXg7AsNC4eACZ0WzSTmqXJ5g9UPzUgElxj1bnfqQSokL9Fxq/rZc3nObbnfdimSRXqbs8MOXPlyLM3CEU3kpkm6zAybZEXGBqAE763EJy9FNVptz4rdU0PDpwuCwi1e2QwXZhu8xc/Y93p5fT5QJqT4RL0hhv5S54XmSXH9YPx+7vxZcRbCeOi0UVg0CDer1gtImGZCiPwer8BvqP8RCcSYzQIJ4mhI764HpIOnFI4kgn9VAxnIe6HZCTZM88vc9znmk4Am/+HEnivhDoSOW6XFnvcUz3N81pX28zdIG9l8EsMvV7Ls+cVeNhiRcRCovI2XQqiwlS9tj8IxiuEt9sJXuSE/c3K0=
